<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta
            name="viewport"
            content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>å±€åŸŸç½‘æ–‡å­—äº’ä¼ </title>
    <style>
        /* æ‰‹æœºç«¯å‹å¥½å¸ƒå±€ */
        @media (max-width: 600px) {
            .row { flex-direction: column; }
            .toolbar { flex-wrap: wrap; }
            #text { min-height: 80px; }
            button { width: 100%; }
        }
        :root {
            --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af;
            --accent:#22c55e; --danger:#ef4444; --border:#1f2937;
        }
        * { box-sizing: border-box; }
        body {
            margin:0; background: var(--bg); color: var(--text); font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji;
            display:flex; min-height:100vh; align-items:center; justify-content:center; padding: 16px;
        }
        .container {
            width: 100%; max-width: 860px; background: var(--card); border: 1px solid var(--border);
            border-radius: 16px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.35);
        }
        .row { display:flex; gap: 12px; flex-wrap: wrap; align-items: center; }
        .row > * { flex: 1; min-width: 160px; }
        h1 { font-size: 20px; margin: 4px 0 12px; letter-spacing: .5px; }
        .muted { color: var(--muted); font-size: 12px; }
        input, textarea, button, select {
            background: #0b1220; color: var(--text); border: 1px solid var(--border);
            border-radius: 10px; padding: 10px 12px; outline: none; width: 100%;
        }
        input:focus, textarea:focus { border-color: #334155; }
        button {
            cursor: pointer; font-weight: 600;
            transition: transform .05s ease, background .2s ease, opacity .2s ease;
        }
        button.primary { background: var(--accent); color: #07210f; border-color: transparent; }
        button.danger { background: var(--danger); color: white; border-color: transparent; }
        button:active { transform: translateY(1px); }
        .chat {
            height: 46vh; min-height: 260px; overflow-y: auto; padding: 12px; border: 1px dashed #263043; border-radius: 12px; background: #0b1220;
        }
        .msg { margin: 8px 0; padding: 10px 12px; border-radius: 12px; background: #0e1628; border: 1px solid #1f2a44; }
        .sys { background: #0c1322; color: #9fb3c8; font-size: 12px; border-style: dashed; }
        .me { border-color: #284d35; background: #0e1d15; }
        .head { font-weight: 700; font-size: 13px; margin-bottom: 4px; display:flex; gap:8px; align-items:baseline; }
        .ts { font-size: 11px; color: var(--muted); }
        .toolbar { display:flex; gap: 8px; }
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
        .nowrap { white-space: nowrap; }
    </style>
    
</head>
<body>
<div class="container">
    <h1>ğŸŸ¢ å±€åŸŸç½‘æ–‡å­—äº’ä¼ </h1>
    <div class="row" style="margin-bottom:10px;">
        <div>
            <label class="muted">æ˜µç§°</label>
            <input id="nickname" placeholder="ä¾‹å¦‚ï¼šå°æ˜" maxlength="32" />
        </div>
        <div>
            <label class="muted">æˆ¿é—´ç ï¼ˆå¯é€‰ï¼Œé»˜è®¤åŒæˆ¿ï¼‰</label>
            <input id="room" class="mono" placeholder="ä¾‹å¦‚ï¼šteam1" />
        </div>
        <div style="flex:0 0 180px; margin-top:20px;">
            <button id="connectBtn" class="primary">è¿æ¥</button>
        </div>
    </div>

    <div id="chat" class="chat" aria-live="polite"></div>

    <div style="margin:10px 0;"></div>

    <div class="row">
        <textarea id="text" rows="3" placeholder="è¾“å…¥è¦å‘é€çš„æ–‡å­—ï¼ˆå›è½¦å‘é€ï¼ŒShift+å›è½¦æ¢è¡Œï¼‰"></textarea>
    </div>
    <div style="height:10px;"></div>
    <div class="toolbar">
        <button id="sendBtn" class="primary">å‘é€</button>
        <button id="fileBtn" class="primary">å‘é€æ–‡ä»¶</button>
        <input type="file" id="fileInput" style="display: none;" accept="*/*" />
        <button id="copyBtn">å¤åˆ¶é€‰ä¸­æ–‡æœ¬/æœ€æ–°æ¶ˆæ¯</button>
        <button id="clearBtn" class="danger">æ¸…ç©ºæœ¬åœ°è®°å½•</button>
        <div class="muted nowrap" style="margin-left:auto;">å½“å‰åœ°å€ï¼š<span id="addr" class="mono"></span></div>
    </div>
    <div class="muted" style="margin-top:6px;">
        å°æŠ€å·§ï¼šæŠŠ URL æ”¹æˆ <span class="mono">http://&lt;ä½ çš„å±€åŸŸç½‘IP&gt;:3000/?room=team1</span>ï¼Œä¸åŒå°ç»„äº’ä¸æ‰“æ‰°ã€‚
    </div>
</div>

<script>
    // åˆ¤æ–­æ˜¯å¦ä¸ºæœ¬åœ°ç¯å¢ƒ
    const isLocal = window.location.hostname === 'localhost' || 
                   window.location.hostname === '127.0.0.1' || 
                   window.location.hostname.startsWith('192.') || 
                   window.location.hostname.startsWith('172.');

    if (!isLocal) {
        // éæœ¬åœ°ç¯å¢ƒï¼ŒåŠ¨æ€åŠ è½½ index.ably.html çš„å†…å®¹
        fetch('index.ably.html')
            .then(response => response.text())
            .then(html => {
                document.open();
                document.write(html);
                document.close();
            })
            .catch(error => {
                console.error('åŠ è½½ Ably ç‰ˆæœ¬å¤±è´¥:', error);
            });
    } else {
        // æœ¬åœ°ç¯å¢ƒï¼Œä½¿ç”¨é»˜è®¤é€»è¾‘
        const $ = (id) => document.getElementById(id);
    const chat = $("chat");
    const text = $("text");
    const nickname = $("nickname");
    const roomInput = $("room");
    const connectBtn = $("connectBtn");
    const sendBtn = $("sendBtn");
    const fileBtn = $("fileBtn");
    const fileInput = $("fileInput");
    const copyBtn = $("copyBtn");
    const clearBtn = $("clearBtn");
    const addr = $("addr");

    // æ˜¾ç¤ºå½“å‰å¯åˆ†äº«åœ°å€ï¼ˆä½¿ç”¨å½“å‰ hostï¼‰
    addr.textContent = location.host + (location.search || "");

    // ä» URL è¯»å– room åˆå€¼
    const urlParams = new URLSearchParams(location.search);
    roomInput.value = urlParams.get("room") || "";

    let ws = null;
    let connected = false;

    function wsUrl() {
        const proto = location.protocol === "https:" ? "wss" : "ws";
        const base = `${proto}://${location.host}`;
        const room = roomInput.value.trim();
        const qs = new URLSearchParams(location.search);
        if (room) qs.set("room", room);
        return base + "/?" + qs.toString();
    }

    function addMsg({ kind = "chat", nickname = "åŒ¿å", text = "", ts = Date.now(), self = false }) {
        const div = document.createElement("div");
        div.className = "msg " + (kind === "system" ? "sys" : self ? "me" : "");
        const timeStr = new Date(ts).toLocaleString();
        if (kind === "system") {
            div.innerHTML = `<div class="head">ç³»ç»Ÿ<span class="ts">${timeStr}</span></div><div>${escapeHtml(text)}</div>`;
        } else {
            div.innerHTML = `<div class="head">${escapeHtml(nickname)}<span class="ts">${timeStr}</span></div><div>${linkify(escapeHtml(text))}</div>`;
        }
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
        // æœ¬åœ°å­˜å‚¨ç”¨äºåˆ·æ–°åä¿ç•™
        persist();
        return div; // è¿”å›åˆ›å»ºçš„DOMå…ƒç´ 
    }

    function addFileMsg({ kind = "file", nickname = "åŒ¿å", file, ts = Date.now(), self = false }) {
        const div = document.createElement("div");
        div.className = "msg " + (self ? "me" : "");
        
        const timeStr = new Date(ts).toLocaleString();
        const fileSize = formatFileSize(file.size);
        
        // æ ¹æ®æ–‡ä»¶ç±»å‹å†³å®šæ˜¾ç¤ºæ–¹å¼
        let filePreview = '';
        const fileExt = file.name.split('.').pop().toLowerCase();
        const imageExts = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'];
        const videoExts = ['mp4', 'webm', 'ogg', 'mov', 'avi', 'wmv', 'flv', 'mkv'];
        const docExts = ['pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx'];
        const archiveExts = ['zip', 'rar', '7z', 'tar', 'gz'];
        
        if (imageExts.includes(fileExt)) {
            // å›¾ç‰‡æ–‡ä»¶æ˜¾ç¤ºç¼©ç•¥å›¾
            filePreview = `<div><img src="${file.url}" alt="${escapeHtml(file.name)}" style="max-width: 200px; max-height: 200px; border-radius: 4px; margin-top: 8px;" /></div>`;
        } else if (videoExts.includes(fileExt)) {
            // è§†é¢‘æ–‡ä»¶æ˜¾ç¤ºè§†é¢‘æ’­æ”¾å™¨
            filePreview = `
                <div>
                    <video controls style="max-width: 300px; max-height: 200px; margin-top: 8px;">
                        <source src="${file.url}" type="video/${fileExt}">
                        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
                    </video>
                </div>`;
        } else if (docExts.includes(fileExt)) {
            // æ–‡æ¡£æ–‡ä»¶æ˜¾ç¤ºæ–‡æ¡£å›¾æ ‡
            filePreview = `<div style="margin-top: 8px; font-size: 24px;">ğŸ“</div>`;
        } else if (archiveExts.includes(fileExt)) {
            // å‹ç¼©æ–‡ä»¶æ˜¾ç¤ºå‹ç¼©åŒ…å›¾æ ‡
            filePreview = `<div style="margin-top: 8px; font-size: 24px;">ğŸ“¦</div>`;
        } else {
            // å…¶ä»–æ–‡ä»¶æ˜¾ç¤ºé€šç”¨æ–‡ä»¶å›¾æ ‡
            filePreview = `<div style="margin-top: 8px; font-size: 24px;">ğŸ“„</div>`;
        }
        
        div.innerHTML = `
            <div class="head">${escapeHtml(nickname)}<span class="ts">${timeStr}</span></div>
            <div>
                <div>å‘é€äº†ä¸€ä¸ªæ–‡ä»¶ï¼š</div>
                <div style="margin: 8px 0; padding: 8px; background: #1a2439; border-radius: 6px;">
                    <div><strong>${escapeHtml(file.name)}</strong></div>
                    <div style="font-size: 12px; color: #9ca3af; margin: 4px 0;">${fileSize}</div>
                    ${filePreview}
                    <div style="margin-top: 8px;">
                        <a href="${file.url}" download="${escapeHtml(file.name)}" target="_blank" style="display: inline-block; padding: 6px 12px; background: #22c55e; color: white; border-radius: 4px; text-decoration: none; font-size: 12px;">ä¸‹è½½æ–‡ä»¶</a>
                    </div>
                </div>
            </div>
        `;
        
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
        // æœ¬åœ°å­˜å‚¨ç”¨äºåˆ·æ–°åä¿ç•™
        persist();
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function escapeHtml(s) {
        return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    function linkify(s) {
        // ç®€å•æŠŠ URL å˜æˆå¯ç‚¹å‡»é“¾æ¥
        return s.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>');
    }

    // å¿ƒè·³å®šæ—¶å™¨
    let heartbeatInterval;
    // é‡è¿å®šæ—¶å™¨
    let reconnectTimeout;
    // å¿ƒè·³é—´éš”ï¼ˆæ¯«ç§’ï¼‰
    const HEARTBEAT_INTERVAL = 300000; // 5åˆ†é’Ÿ
    // é‡è¿å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
    const RECONNECT_DELAY = 120000; // 2åˆ†é’Ÿ

    function connect() {
        if (connected) {
            ws?.close();
        }
        
        // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
        if (heartbeatInterval) clearInterval(heartbeatInterval);
        if (reconnectTimeout) clearTimeout(reconnectTimeout);
        
        ws = new WebSocket(wsUrl());
        
        ws.addEventListener("open", () => {
            connected = true;
            connectBtn.textContent = "æ–­å¼€";
            addMsg({ kind: "system", text: "WebSocket å·²è¿æ¥" });
            
            // å¯åŠ¨å¿ƒè·³æœºåˆ¶
            heartbeatInterval = setInterval(() => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: "ping" }));
                }
            }, HEARTBEAT_INTERVAL);
        });
        
        ws.addEventListener("close", () => {
            connected = false;
            connectBtn.textContent = "è¿æ¥";
            
            // æ¸…é™¤å¿ƒè·³å®šæ—¶å™¨
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            
            // æ˜¾ç¤ºæ–­å¼€æ¶ˆæ¯
            addMsg({ kind: "system", text: "è¿æ¥å·²æ–­å¼€" });
            
            // è‡ªåŠ¨é‡è¿ï¼ˆé™¤éç”¨æˆ·æ‰‹åŠ¨æ–­å¼€ï¼‰
            if (connected !== null) {
                reconnectTimeout = setTimeout(() => {
                    if (connected !== false) { // åªæœ‰åœ¨ä¸æ˜¯æ‰‹åŠ¨æ–­å¼€çš„æƒ…å†µä¸‹æ‰é‡è¿
                        connect();
                    }
                }, RECONNECT_DELAY);
            }
        });
        
        ws.addEventListener("message", (ev) => {
            try {
                const data = JSON.parse(ev.data);
                
                // å¤„ç†å¿ƒè·³å“åº”
                if (data.type === "pong") {
                    return; // å¿ƒè·³å“åº”ï¼Œæ— éœ€å¤„ç†
                }
                
                if (data.type === "system") {
                    addMsg({ kind: "system", text: data.text, ts: data.ts });
                } else if (data.type === "chat") {
                    addMsg({ kind: "chat", nickname: data.nickname, text: data.text, ts: data.ts });
                } else if (data.type === "file") {
                    addFileMsg({ kind: "file", nickname: data.nickname, file: data.file, ts: data.ts });
                }
            } catch {}
        });
        
        // é”™è¯¯å¤„ç†
        ws.addEventListener("error", (error) => {
            console.error("WebSocket é”™è¯¯:", error);
            addMsg({ kind: "system", text: "è¿æ¥å‘ç”Ÿé”™è¯¯ï¼Œå°†å°è¯•é‡æ–°è¿æ¥..." });
        });
    }

    // ä¿®æ”¹æ–­å¼€è¿æ¥æŒ‰é’®çš„å¤„ç†é€»è¾‘
    connectBtn.onclick = () => {
        if (!connected) {
            // è¿æ¥
            connected = null; // æ ‡è®°ä¸ºç”¨æˆ·ä¸»åŠ¨è¿æ¥
            connect();
        } else {
            // æ–­å¼€è¿æ¥
            connected = false; // æ ‡è®°ä¸ºç”¨æˆ·ä¸»åŠ¨æ–­å¼€
            if (reconnectTimeout) clearTimeout(reconnectTimeout);
            ws?.close();
        }
    };

    function send() {
        if (!connected || !ws || ws.readyState !== WebSocket.OPEN) {
            addMsg({ kind: "system", text: "æœªè¿æ¥ï¼Œæ— æ³•å‘é€ã€‚" });
            return;
        }
        const content = text.value.trim();
        if (!content) return;
        const nick = nickname.value.trim() || "åŒ¿å";
        const packet = { type: "chat", nickname: nick, text: content };
        ws.send(JSON.stringify(packet));
        addMsg({ kind: "chat", nickname: nick + "ï¼ˆæˆ‘ï¼‰", text: content, self: true });
        text.value = "";
        text.focus();
    }

    // å¿«æ·é”®ï¼šEnter å‘é€ï¼ŒShift+Enter æ¢è¡Œ
    text.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault(); send();
        }
    });

    // æ–‡ä»¶ä¸Šä¼ å¤„ç†
    fileBtn.onclick = () => {
        fileInput.click();
    };

    fileInput.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        if (!connected || !ws || ws.readyState !== WebSocket.OPEN) {
            addMsg({ kind: "system", text: "æœªè¿æ¥ï¼Œæ­£åœ¨å°è¯•é‡æ–°è¿æ¥..." });
            connect();
            return;
        }
        
        // ç§»é™¤æ–‡ä»¶å¤§å°é™åˆ¶ï¼Œä½†æ·»åŠ ä¸€ä¸ªåˆç†çš„è­¦å‘Šï¼ˆ100MBï¼‰
        if (file.size > 100 * 1024 * 1024) {
            if (!confirm(`æ–‡ä»¶å¤§å°ä¸º ${formatFileSize(file.size)}ï¼Œç¡®å®šè¦å‘é€å—ï¼Ÿ`)) {
                return;
            }
        }
        
        // æ˜¾ç¤ºä¸Šä¼ ä¸­æ¶ˆæ¯
        const uploadingMsg = addMsg({ 
            kind: "system", 
            text: `æ­£åœ¨ä¸Šä¼ æ–‡ä»¶: ${file.name}...` 
        });
        
        try {
            // ä½¿ç”¨ FormData ä¸Šä¼ æ–‡ä»¶ï¼ˆæ›´é«˜æ•ˆï¼‰
            const formData = new FormData();
            formData.append('file', file);
            formData.append('roomId', roomInput.value || "default");
            
            // ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨
            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (response.ok) {
                // å‘é€æ–‡ä»¶æ¶ˆæ¯åˆ° WebSocket
                const nick = nickname.value.trim() || "åŒ¿å";
                const fileData = {
                    url: result.url,
                    name: file.name,
                    size: result.fileSize
                };
                
                const packet = { 
                    type: "file", 
                    nickname: nick, 
                    file: fileData
                };
                ws.send(JSON.stringify(packet));
                
                // åœ¨å‘é€æ–¹æœ¬åœ°æ˜¾ç¤ºæ–‡ä»¶é¢„è§ˆ
                addFileMsg({ 
                    kind: "file", 
                    nickname: nick + "ï¼ˆæˆ‘ï¼‰", 
                    file: fileData, 
                    self: true 
                });
                
                // æ›´æ–°æ¶ˆæ¯æ˜¾ç¤º
                uploadingMsg.innerHTML = `<div class="head">ç³»ç»Ÿ<span class="ts">${new Date().toLocaleString()}</span></div><div>æ–‡ä»¶ä¸Šä¼ æˆåŠŸ: ${file.name}</div>`;
            } else {
                throw new Error(result.error || 'ä¸Šä¼ å¤±è´¥');
            }
        } catch (error) {
            console.error('æ–‡ä»¶ä¸Šä¼ é”™è¯¯:', error);
            addMsg({ kind: "system", text: `æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ${error.message}` });
        }
    };

    sendBtn.onclick = send;

    copyBtn.onclick = async () => {
        let selected = window.getSelection()?.toString();
        if (!selected) {
            const last = chat.querySelector(".msg:last-child");
            selected = last ? last.innerText : "";
        }
        if (!selected) return;
        try {
            await navigator.clipboard.writeText(selected);
            addMsg({ kind: "system", text: "å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼š" + (selected.length > 30 ? selected.slice(0,30) + "..." : selected) });
        } catch {
            addMsg({ kind: "system", text: "å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬å¤åˆ¶ã€‚" });
        }
    };

    clearBtn.onclick = () => {
        chat.innerHTML = "";
        localStorage.removeItem("lan-chat-history");
        addMsg({ kind: "system", text: "å·²æ¸…ç©ºæœ¬åœ°æ¶ˆæ¯è®°å½•ï¼ˆä¸å½±å“ä»–äººï¼‰ã€‚" });
    };

    // æœ¬åœ°æŒä¹…åŒ–ï¼ˆä»…å½“å‰è®¾å¤‡ï¼‰
    function persist() {
        const items = Array.from(chat.querySelectorAll(".msg")).map(div => div.outerHTML);
        localStorage.setItem("lan-chat-history", JSON.stringify(items));
    }
    function restore() {
        const raw = localStorage.getItem("lan-chat-history");
        if (!raw) return;
        try {
            const items = JSON.parse(raw);
            items.forEach(html => {
                const div = document.createElement("div");
                div.outerHTML = html; // å®‰å…¨ï¼šè¿™äº›å†…å®¹ç”±æˆ‘ä»¬è‡ªå·±ä¿å­˜
                chat.insertAdjacentHTML("beforeend", html);
            });
            chat.scrollTop = chat.scrollHeight;
        } catch {}
    }
    restore();

    // é¦–æ¬¡è‡ªåŠ¨å°è¯•è¿æ¥
    connect();
    }
</script>
</body>
</html>
