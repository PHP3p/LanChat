<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAN Chat - Ably Chat版</title>
    <!-- 引入Ably Chat SDK -->
    <script src="js/ably.min.js"></script>
    <style>
        /* 手机端友好布局 */
        @media (max-width: 600px) {
            .row { flex-direction: column; }
            .toolbar { flex-wrap: wrap; }
            #text { min-height: 80px; }
            button { width: 100%; }
        }
        :root {
            --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af;
            --accent:#22c55e; --danger:#ef4444; --border:#1f2937;
        }
        * { box-sizing: border-box; }
        body {
            margin:0; background: var(--bg); color: var(--text); font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji;
            display:flex; min-height:100vh; align-items:center; justify-content:center; padding: 16px;
        }
        .container {
            width: 100%; max-width: 860px; background: var(--card); border: 1px solid var(--border);
            border-radius: 16px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.35);
        }
        .row { display:flex; gap: 12px; flex-wrap: wrap; align-items: center; }
        .row > * { flex: 1; min-width: 160px; }
        h1 { font-size: 20px; margin: 4px 0 12px; letter-spacing: .5px; }
        .muted { color: var(--muted); font-size: 12px; }
        input, textarea, button, select {
            background: #0b1220; color: var(--text); border: 1px solid var(--border);
            border-radius: 10px; padding: 10px 12px; outline: none; width: 100%;
        }
        input:focus, textarea:focus { border-color: #334155; }
        button {
            cursor: pointer; font-weight: 600;
            transition: transform .05s ease, background .2s ease, opacity .2s ease;
        }
        button.primary { background: var(--accent); color: #07210f; border-color: transparent; }
        button.danger { background: var(--danger); color: white; border-color: transparent; }
        button:active { transform: translateY(1px); }
        .chat {
            height: 46vh; min-height: 260px; overflow-y: auto; padding: 12px; border: 1px dashed #263043; border-radius: 12px; background: #0b1220;
        }
        .msg { margin: 8px 0; padding: 10px 12px; border-radius: 12px; background: #0e1628; border: 1px solid #1f2a44; }
        .sys { background: #0c1322; color: #9fb3c8; font-size: 12px; border-style: dashed; }
        .me { border-color: #284d35; background: #0e1d15; }
        .head { font-weight: 700; font-size: 13px; margin-bottom: 4px; display:flex; gap:8px; align-items:baseline; }
        .ts { font-size: 11px; color: var(--muted); }
        .toolbar { display:flex; gap: 8px; }
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
        .nowrap { white-space: nowrap; }
    </style>
</head>
<body>
    <div class="container">
    <h1>🟢 局域网文字互传 - Ably版</h1>
    <div class="row" style="margin-bottom:10px;">
        <div>
            <label class="muted">昵称</label>
            <input id="nickname" placeholder="例如：小明" maxlength="32" />
        </div>
        <div>
            <label class="muted">房间码（可选，默认同房）</label>
            <input id="room" class="mono" placeholder="例如：team1" />
        </div>
        <div style="flex:0 0 180px; margin-top:20px;">
            <button id="connectBtn" class="primary">连接</button>
        </div>
    </div>

    <div id="chat" class="chat" aria-live="polite"></div>

    <div style="margin:10px 0;"></div>

    <div class="row">
        <textarea id="text" rows="3" placeholder="输入要发送的文字（回车发送，Shift+回车换行）"></textarea>
    </div>
    <div style="height:10px;"></div>
    <div class="toolbar">
        <button id="sendBtn" class="primary">发送</button>
        <button id="fileBtn" class="primary">发送文件</button>
        <input type="file" id="fileInput" style="display: none;" accept="*/*" />
        <button id="copyBtn">复制选中文本/最新消息</button>
        <button id="clearBtn" class="danger">清空本地记录</button>
        <div class="muted nowrap" style="margin-left:auto;">当前地址：<span id="addr" class="mono"></span></div>
    </div>
    <div class="muted" style="margin-top:6px;">
        小技巧：把 URL 改成 <span class="mono">http://&lt;你的局域网IP&gt;:3000/?room=team1</span>，不同小组互不打扰。
    </div>
</div>

    <script>
        // DOM元素
        const chatElement = document.getElementById('chat');
        const messageInput = document.getElementById('text');
        const sendButton = document.getElementById('sendBtn');
        const connectButton = document.getElementById('connectBtn');
        const nicknameInput = document.getElementById('nickname');
        const roomInput = document.getElementById('room');
        
        let ablyClient = null;
        let channel = null;
        
        // 添加消息到聊天窗口
        function addMessage(message, type = 'other') {
            const messageElement = document.createElement('div');
            messageElement.className = `msg ${type}`;
            messageElement.innerHTML = message;
            chatElement.appendChild(messageElement);
            chatElement.scrollTop = chatElement.scrollHeight;
        }
        
        // 初始化Ably客户端
        async function initAblyChat() {
            try {
                const nickname = nicknameInput.value.trim() || `用户-${Math.random().toString(36).substr(2, 4)}`;
                const roomName = roomInput.value.trim() || 'default-room';
                
                // 创建Ably Realtime客户端
                ablyClient = new Ably.Realtime({
                    key: "gKBpjg._VtU5w:LsMU5sXzmPha_OFgm5rqk2oBBawgASoMVXEOmjC18pQ",
                    clientId: nickname
                });
                
                // 监听连接状态变化
                ablyClient.connection.on((stateChange) => {
                    console.log("Connection state changed to", stateChange.current);
                    
                    if (stateChange.current === 'connected') {
                        sendButton.disabled = false;
                    } else if (stateChange.current === 'disconnected' || stateChange.current === 'failed') {
                        sendButton.disabled = true;
                        addMessage(`<div class="sys">连接失败: ${stateChange.reason || '未知错误'}</div>`, 'sys');
                        if (stateChange.reason && stateChange.reason.includes('80023')) {
                            addMessage('<div class="sys">错误: 跨站点连接问题，请检查密钥配置</div>', 'sys');
                        }
                    }
                });
                
                // 获取频道
                channel = ablyClient.channels.get(roomName);
                
                // 订阅消息
                channel.subscribe((message) => {
                    // 不显示自己发送的消息
                    if (message.clientId !== ablyClient.clientId) {
                        addMessage(`<div class="head">${message.clientId} <span class="ts">${new Date().toLocaleTimeString()}</span></div>${message.data.text}`, 'other');
                    }
                });
                
                // 附加到频道
                await channel.attach();
                
                addMessage('<div class="sys">已连接到聊天室</div>', 'sys');
                sendButton.disabled = false;
                
            } catch (error) {
                console.error('初始化Ably Chat失败:', error);
                addMessage(`<div class="sys">错误: 初始化Ably Chat失败 - ${error.message}</div>`, 'sys');
                sendButton.disabled = true;
            }
        }
        
        // 发送消息
        async function sendMessage() {
            if (!channel) {
                addMessage('<div class="sys">错误: 未连接到聊天室</div>', 'sys');
                return;
            }
            
            const messageText = messageInput.value.trim();
            if (messageText) {
                try {
                    await channel.publish('message', {
                        text: messageText
                    });
                    addMessage(`<div class="head">我 <span class="ts">${new Date().toLocaleTimeString()}</span></div>${messageText}`, 'me');
                    messageInput.value = '';
                } catch (error) {
                    addMessage(`<div class="sys">发送失败: ${error.message}</div>`, 'sys');
                }
            }
        }
        
        // 事件监听
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        connectButton.addEventListener('click', initAblyChat);
        
        // 页面关闭前清理
        window.addEventListener('beforeunload', async () => {
            if (channel) {
                try {
                    await channel.detach();
                } catch (error) {
                    console.error('清理失败:', error);
                }
            }
            
            if (ablyClient) {
                try {
                    await ablyClient.close();
                } catch (error) {
                    console.error('关闭Ably客户端失败:', error);
                }
            }
        });
    </script>
</body>
</html>