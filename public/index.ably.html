<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAN Chat - Ably Chatç‰ˆ</title>
    <!-- å¼•å…¥Ably Chat SDK -->
    <script src="js/ably.min.js"></script>
    <style>
        /* æ‰‹æœºç«¯å‹å¥½å¸ƒå±€ */
        @media (max-width: 600px) {
            .row { flex-direction: column; }
            .toolbar { flex-wrap: wrap; }
            #text { min-height: 80px; }
            button { width: 100%; }
        }
        :root {
            --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af;
            --accent:#22c55e; --danger:#ef4444; --border:#1f2937;
        }
        * { box-sizing: border-box; }
        body {
            margin:0; background: var(--bg); color: var(--text); font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji;
            display:flex; min-height:100vh; align-items:center; justify-content:center; padding: 16px;
        }
        .container {
            width: 100%; max-width: 860px; background: var(--card); border: 1px solid var(--border);
            border-radius: 16px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.35);
        }
        .row { display:flex; gap: 12px; flex-wrap: wrap; align-items: center; }
        .row > * { flex: 1; min-width: 160px; }
        h1 { font-size: 20px; margin: 4px 0 12px; letter-spacing: .5px; }
        .muted { color: var(--muted); font-size: 12px; }
        input, textarea, button, select {
            background: #0b1220; color: var(--text); border: 1px solid var(--border);
            border-radius: 10px; padding: 10px 12px; outline: none; width: 100%;
        }
        input:focus, textarea:focus { border-color: #334155; }
        button {
            cursor: pointer; font-weight: 600;
            transition: transform .05s ease, background .2s ease, opacity .2s ease;
        }
        button.primary { background: var(--accent); color: #07210f; border-color: transparent; }
        button.danger { background: var(--danger); color: white; border-color: transparent; }
        button:active { transform: translateY(1px); }
        .chat {
            height: 46vh; min-height: 260px; overflow-y: auto; padding: 12px; border: 1px dashed #263043; border-radius: 12px; background: #0b1220;
        }
        .msg { margin: 8px 0; padding: 10px 12px; border-radius: 12px; background: #0e1628; border: 1px solid #1f2a44; }
        .sys { background: #0c1322; color: #9fb3c8; font-size: 12px; border-style: dashed; }
        .me { border-color: #284d35; background: #0e1d15; }
        .head { font-weight: 700; font-size: 13px; margin-bottom: 4px; display:flex; gap:8px; align-items:baseline; }
        .ts { font-size: 11px; color: var(--muted); }
        .toolbar { display:flex; gap: 8px; }
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
        .nowrap { white-space: nowrap; }
    </style>
</head>
<body>
    <div class="container">
    <h1>ğŸŸ¢ å±€åŸŸç½‘æ–‡å­—äº’ä¼  - Ablyç‰ˆ</h1>
    <div class="row" style="margin-bottom:10px;">
        <div>
            <label class="muted">æ˜µç§°</label>
            <input id="nickname" placeholder="ä¾‹å¦‚ï¼šå°æ˜" maxlength="32" />
        </div>
        <div>
            <label class="muted">æˆ¿é—´ç ï¼ˆå¯é€‰ï¼Œé»˜è®¤åŒæˆ¿ï¼‰</label>
            <input id="room" class="mono" placeholder="ä¾‹å¦‚ï¼šteam1" />
        </div>
        <div style="flex:0 0 180px; margin-top:20px;">
            <button id="connectBtn" class="primary">è¿æ¥</button>
        </div>
    </div>

    <div id="chat" class="chat" aria-live="polite"></div>

    <div style="margin:10px 0;"></div>

    <div class="row">
        <textarea id="text" rows="3" placeholder="è¾“å…¥è¦å‘é€çš„æ–‡å­—ï¼ˆå›è½¦å‘é€ï¼ŒShift+å›è½¦æ¢è¡Œï¼‰"></textarea>
    </div>
    <div style="height:10px;"></div>
    <div class="toolbar">
        <button id="sendBtn" class="primary">å‘é€</button>
        <button id="fileBtn" class="primary">å‘é€æ–‡ä»¶</button>
        <input type="file" id="fileInput" style="display: none;" accept="*/*" />
        <button id="copyBtn">å¤åˆ¶é€‰ä¸­æ–‡æœ¬/æœ€æ–°æ¶ˆæ¯</button>
        <button id="clearBtn" class="danger">æ¸…ç©ºæœ¬åœ°è®°å½•</button>
        <div class="muted nowrap" style="margin-left:auto;">å½“å‰åœ°å€ï¼š<span id="addr" class="mono"></span></div>
    </div>
    <div class="muted" style="margin-top:6px;">
        å°æŠ€å·§ï¼šæŠŠ URL æ”¹æˆ <span class="mono">http://&lt;ä½ çš„å±€åŸŸç½‘IP&gt;:3000/?room=team1</span>ï¼Œä¸åŒå°ç»„äº’ä¸æ‰“æ‰°ã€‚
    </div>
</div>

    <script>
        // DOMå…ƒç´ 
        const chatElement = document.getElementById('chat');
        const messageInput = document.getElementById('text');
        const sendButton = document.getElementById('sendBtn');
        const connectButton = document.getElementById('connectBtn');
        const nicknameInput = document.getElementById('nickname');
        const roomInput = document.getElementById('room');
        
        let ablyClient = null;
        let channel = null;
        
        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©çª—å£
        function addMessage(message, type = 'other') {
            const messageElement = document.createElement('div');
            messageElement.className = `msg ${type}`;
            messageElement.innerHTML = message;
            chatElement.appendChild(messageElement);
            chatElement.scrollTop = chatElement.scrollHeight;
        }
        
        // åˆå§‹åŒ–Ablyå®¢æˆ·ç«¯
        async function initAblyChat() {
            try {
                const nickname = nicknameInput.value.trim() || `ç”¨æˆ·-${Math.random().toString(36).substr(2, 4)}`;
                const roomName = roomInput.value.trim() || 'default-room';
                
                // åˆ›å»ºAbly Realtimeå®¢æˆ·ç«¯
                ablyClient = new Ably.Realtime({
                    key: "gKBpjg._VtU5w:LsMU5sXzmPha_OFgm5rqk2oBBawgASoMVXEOmjC18pQ",
                    clientId: nickname
                });
                
                // ç›‘å¬è¿æ¥çŠ¶æ€å˜åŒ–
                ablyClient.connection.on((stateChange) => {
                    console.log("Connection state changed to", stateChange.current);
                    
                    if (stateChange.current === 'connected') {
                        sendButton.disabled = false;
                    } else if (stateChange.current === 'disconnected' || stateChange.current === 'failed') {
                        sendButton.disabled = true;
                    }
                });
                
                // è·å–é¢‘é“
                channel = ablyClient.channels.get(roomName);
                
                // è®¢é˜…æ¶ˆæ¯
                channel.subscribe((message) => {
                    // ä¸æ˜¾ç¤ºè‡ªå·±å‘é€çš„æ¶ˆæ¯
                    if (message.clientId !== ablyClient.clientId) {
                        addMessage(`<div class="head">${message.clientId} <span class="ts">${new Date().toLocaleTimeString()}</span></div>${message.data.text}`, 'other');
                    }
                });
                
                // é™„åŠ åˆ°é¢‘é“
                await channel.attach();
                
                addMessage('<div class="sys">å·²è¿æ¥åˆ°èŠå¤©å®¤</div>', 'sys');
                sendButton.disabled = false;
                
            } catch (error) {
                console.error('åˆå§‹åŒ–Ably Chatå¤±è´¥:', error);
                addMessage(`<div class="sys">é”™è¯¯: åˆå§‹åŒ–Ably Chatå¤±è´¥ - ${error.message}</div>`, 'sys');
                sendButton.disabled = true;
            }
        }
        
        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            if (!channel) {
                addMessage('<div class="sys">é”™è¯¯: æœªè¿æ¥åˆ°èŠå¤©å®¤</div>', 'sys');
                return;
            }
            
            const messageText = messageInput.value.trim();
            if (messageText) {
                try {
                    await channel.publish('message', {
                        text: messageText
                    });
                    addMessage(`<div class="head">æˆ‘ <span class="ts">${new Date().toLocaleTimeString()}</span></div>${messageText}`, 'me');
                    messageInput.value = '';
                } catch (error) {
                    addMessage(`<div class="sys">å‘é€å¤±è´¥: ${error.message}</div>`, 'sys');
                }
            }
        }
        
        // äº‹ä»¶ç›‘å¬
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        connectButton.addEventListener('click', initAblyChat);
        
        // é¡µé¢å…³é—­å‰æ¸…ç†
        window.addEventListener('beforeunload', async () => {
            if (channel) {
                try {
                    await channel.detach();
                } catch (error) {
                    console.error('æ¸…ç†å¤±è´¥:', error);
                }
            }
            
            if (ablyClient) {
                try {
                    await ablyClient.close();
                } catch (error) {
                    console.error('å…³é—­Ablyå®¢æˆ·ç«¯å¤±è´¥:', error);
                }
            }
        });
    </script>
</body>
</html>